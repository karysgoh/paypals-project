generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================================
// ENUMS
// ======================================

enum UserStatus {
  active
  inactive
  suspended
}

enum CircleMemberRole {
  admin
  member
}

enum CircleMemberStatus {
  active
  pending
  removed
}

enum CircleTypeEnum {
  friends
  family
  roommates
  travel
  project
  colleagues
  couple
}

enum TransactionStatus {
  pending
  completed
  cancelled
}

enum PaymentStatus {
  unpaid
  paid
  pending
  failed
}

enum PaymentMethod {
  venmo
  paypal
  cash
  bank_transfer
  zelle
  other
}

enum InvitationStatus {
  pending
  accepted
  rejected
  expired
}

enum NotificationType {
  transaction_created
  payment_due
  payment_received
  circle_invitation
  member_joined
  general
}

enum NotificationChannel {
  email
  push
  in_app
}

enum DeliveryStatus {
  pending
  sent
  delivered
  read
  failed
}

enum TransactionCategoryEnum {
  food
  travel
  entertainment
  shopping
  transportation
  utilities
  rent
  groceries
  healthcare
  education
  other
}

// ======================================
// SYSTEM ADMINISTRATION MODELS
// ======================================

model Role {
  id          Int        @id @default(autoincrement())
  role_name   String     @unique
  description String?

  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id              Int        @id @default(autoincrement())
  permission_name String     @unique
  description     String?

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  role_id       Int
  permission_id Int

  role       Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@map("role_permissions")
}

// ======================================
// CORE USER MODEL
// ======================================

model User {
  id             Int        @id @default(autoincrement())
  username       String     @unique
  password       String     @db.VarChar(255)
  phone_number   String?
  email          String     @unique
  email_verified Boolean    @default(false)
  role_id        Int?
  status         UserStatus @default(active)
  
  paynow_phone   String?    @db.VarChar(20)  
  paynow_nric    String?    @db.VarChar(20) 
  paynow_enabled Boolean    @default(false) 

  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt

  // Relations
  role                     Role?                      @relation(fields: [role_id], references: [id])
  circleMembers            CircleMember[]
  createdTransactions      Transaction[]              @relation("TransactionCreator")
  transactionMembers  TransactionMember[]
  sentInvitations          Invitation[]               @relation("InvitationSender")
  receivedInvitations      Invitation[]               @relation("InvitationReceiver")
  notifications            Notification[]
  auditLogs                AuditLog[]
  emailVerificationTokens  EmailVerificationToken[]

  @@map("users")
  @@index([username])
  @@index([email])
}

// ======================================
// CIRCLE MANAGEMENT
// ======================================

model Circle {
  id         Int            @id @default(autoincrement())
  name       String
  type       CircleTypeEnum @default(friends)

  created_at DateTime   @default(now())
  updated_at DateTime   @updatedAt

  // Relations
  members      CircleMember[]
  transactions Transaction[]
  invitations  Invitation[]
  notifications Notification[]

  @@map("circles")
  @@index([name])
  @@index([type])
}

model CircleMember {
  circle_id Int
  user_id   Int
  role      CircleMemberRole   @default(member)
  status    CircleMemberStatus @default(active)
  joined_at DateTime           @default(now())

  circle Circle @relation(fields: [circle_id], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([circle_id, user_id])
  @@map("circle_members")
  @@index([user_id])
  @@index([circle_id])
}

// ======================================
// TRANSACTION MANAGEMENT
// ======================================
model Transaction {
  id             Int               @id @default(autoincrement())
  category       TransactionCategoryEnum @default(other) 
  circle_id      Int
  name           String
  description    String?
  
  // Location fields
  location_name  String?          // "Starbucks Downtown"
  location_lat   Decimal?         @db.Decimal(10, 8)
  location_lng   Decimal?         @db.Decimal(11, 8)
  place_id       String?          // Google Places ID for reference
  formatted_address String?       // Full formatted address

  total_amount   Decimal           @db.Decimal(14, 2)

  gst_rate       Decimal?          @db.Decimal(5, 4) // e.g., 0.0700 for 7% GST
  service_charge_rate Decimal?     @db.Decimal(5, 4) // e.g., 0.1000 for 10% service charge
  gst_amount     Decimal?          @db.Decimal(14, 2)
  service_charge_amount Decimal?   @db.Decimal(14, 2)
  base_amount    Decimal?          @db.Decimal(14, 2) // Amount before GST/service charge
  
  status         TransactionStatus @default(pending)
  created_by     Int
  expense_date   DateTime          @default(now())
  created_at     DateTime          @default(now())
  updated_at     DateTime          @updatedAt

  circle       Circle               @relation(fields: [circle_id], references: [id], onDelete: Cascade)
  creator      User                 @relation("TransactionCreator", fields: [created_by], references: [id])
  members TransactionMember[]
  notifications Notification[]

  @@map("transactions")
  @@index([circle_id])
  @@index([created_by])
  @@index([status])
  @@index([expense_date])
  @@index([created_at])
}

model TransactionMember {
  id                  Int           @id @default(autoincrement())
  transaction_id      Int
  user_id             Int?          
  amount_owed         Decimal       @db.Decimal(14, 2)
  payment_status      PaymentStatus @default(unpaid)
  payment_method      PaymentMethod?
  external_payment_id String?
  paid_at             DateTime?
  
  // External participant fields
  external_email      String?       
  external_name       String?       
  access_token        String?       
  access_token_expires DateTime?    
  is_external         Boolean       @default(false)

  transaction Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("transaction_members")
  @@index([user_id])
  @@index([external_email])
  @@index([access_token])
  @@index([payment_status])
  @@index([is_external])
  @@unique([transaction_id, user_id, external_email], name: "unique_participant")
}
  
// ======================================
// INVITATION SYSTEM
// ======================================

model Invitation {
  id          Int              @id @default(autoincrement())
  circle_id   Int
  inviter_id  Int
  invitee_id  Int?
  email       String?
  status      InvitationStatus @default(pending)
  created_at  DateTime         @default(now())
  expires_at  DateTime

  circle   Circle @relation(fields: [circle_id], references: [id], onDelete: Cascade)
  inviter  User   @relation("InvitationSender", fields: [inviter_id], references: [id])
  invitee  User?   @relation("InvitationReceiver", fields: [invitee_id], references: [id])

  @@map("invitations")
  @@index([invitee_id, status])
  @@index([expires_at])
}

// ======================================
// NOTIFICATION SYSTEM
// ======================================

model Notification {
  id                     Int                 @id @default(autoincrement())
  user_id                Int
  type                   NotificationType
  title                  String
  message                String
  is_read                Boolean             @default(false)
  delivery_status        DeliveryStatus      @default(pending)
  notification_channel   NotificationChannel @default(in_app)
  related_transaction_id Int?
  related_circle_id      Int?
  created_at             DateTime            @default(now())

  user                User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  related_transaction Transaction? @relation(fields: [related_transaction_id], references: [id])
  related_circle      Circle?      @relation(fields: [related_circle_id], references: [id])

  @@map("notifications")
  @@index([user_id])
  @@index([user_id, is_read])
  @@index([created_at])
  @@index([type])
  @@index([related_transaction_id])
  @@index([related_circle_id])
}

// ======================================
// SECURITY & AUDIT
// ======================================

model EmailVerificationToken {
  id         Int      @id @default(autoincrement())
  email      String
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  user_id    Int?
  used       Boolean  @default(false)

  user User? @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
  @@index([email])
  @@index([expires_at])
}

model AuditLog {
  id             Int       @id @default(autoincrement())
  performed_by   Int?
  action_type    String
  target_entity  String
  target_id      Int?
  description    String?
  created_at     DateTime  @default(now())

  user User? @relation(fields: [performed_by], references: [id])

  @@map("audit_logs")
  @@index([performed_by])
  @@index([created_at])
  @@index([target_entity])
  @@index([target_id])
}